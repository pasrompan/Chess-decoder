#!/bin/bash

# AI PM Pre-commit Hook
# Automatically updates issue prioritization before each commit

REPO_ROOT="$(git rev-parse --show-toplevel)"
ISSUES_DIR="$REPO_ROOT/ai-pm/issues/active"
PRIORITIZATION_SCRIPT="$REPO_ROOT/ai-pm/scripts/update-prioritization.sh"

# Check if issues directory exists
if [ ! -d "$ISSUES_DIR" ]; then
    exit 0
fi

# Check if prioritization script exists
if [ ! -f "$PRIORITIZATION_SCRIPT" ]; then
    exit 0
fi

# Check if any files in ai-pm/issues/active/ are being committed
if git diff --cached --name-only | grep -q "^ai-pm/issues/active/"; then
    echo "üîÑ Updating issue prioritization..."
    
    # Run prioritization script
    if "$PRIORITIZATION_SCRIPT"; then
        # If prioritization updated files, add them to the commit
        if git diff --name-only | grep -q "^ai-pm/"; then
            echo "üìù Staging updated priority scores..."
            git add ai-pm/issues/active/*.md ai-pm/documentation/prioritized-issues.md 2>/dev/null || true
        fi
        echo "‚úÖ Prioritization updated"
    else
        echo "‚ö†Ô∏è  Prioritization script failed, but continuing with commit"
    fi
fi

exit 0

